<?php /** * I am the Database Access Layer, I can manipulate the database. *  * Your Copywrite information * * @version CodeGen - 1.9.1 * @author CodeGen - Jonnie Spratley - http://code.google.com/p/flex-codegen/ * * @package com.project.codegentest * @name ProjectsService.php */require_once "testConnection.php";require_once "vo/ProjectsVO.php";class ProjectsService{	private $conn;	/**	 * I am the instance of a Database Access Object	 *	 * @return [link]	 */	public function __construct()	{		//TODO: need to enter in the proper credentials		$conn = new testConnection();		$this->conn = $conn;	}	/**	 * I get all records from the specified database and table	 * @return [array]	 */	public function getAllProjects()	{		return $this->_executeReturn("SELECT * FROM test.projects");	}	/**	 * I get one record from the specified database and table.	 *	 * @param [string] $keyvalue the value of your request	 * @return [array] the matching record	 */	public function getOneProjects($keyvalue)	{		return $this->_executeReturn("SELECT * 										FROM test.projects 										WHERE ".$this->_getKey()." = $keyvalue");	}	/**	 * I save a record to the specified database and table	 * @param [string] $vo the name/value object	 * @return [array] the inserted record	 */	public function saveProjects($vo)	{		$choice = '';		$primarykey = $this->_getKey();		$primarykeyValue = $vo[$primarykey];		if ($primarykeyValue == 0 || $primarykeyValue == '')		{			$choice = $this->createProjects($vo);		}		else		{			$choice = $this->updateProjects($vo);		}		return $choice;	}	/**	 * I update a record in the database/table	 *	 * @param [string] $vo the name/value object	 * @return [array] the inserted object	 */	private function updateProjects($vo)	{		//get the primary key		$key = $this->_getKey();		//value of the key		$keyvalue = '';		//check if the object has a key with the same value as the primary key		if (array_key_exists($key, $vo))		{			//set the keyvalue variable to the array key inside the object,			//the key should be the same name as the key in the table			$keyvalue = $vo[$key];		}		//get the columns, the columns should be the name of the keys		//Get the name=values for the update set		$updateSet = '';		foreach ($vo as $name=>$value)		{			$updateSet .= $name.' = '.testConnection::escape($value).', ';		}		$updateSet = testConnection::trimSQL($updateSet);		//build the query		$sql = "UPDATE test.projects SET $updateSet WHERE $key = ".testConnection::escape($keyvalue);		//return sql for debugging		//return $this->_returnSQL ( $sql );		return $this->conn->execute($sql);	}	/**	 * I create a new record in the database/table	 *	 * @param [string] $vo the name/value object	 * @return [boolean] the inserted object	 */	private function createProjects($vo)	{		//get the columns, the columns should be the name of the keys		$voColumns = '';		$voValues = '';		foreach ($vo as $column=>$value)		{			$voColumns .= $column.', ';			$voValues .= testConnection::escape($value).', ';		}		$voColumns = testConnection::trimSQL($voColumns);		$voValues = testConnection::trimSQL($voValues);		//build the query		$sql = "INSERT test.projects ( $voColumns ) VALUES ( $voValues )";		//return		//return $this->_returnSQL ( $sql );		return $this->conn->execute($sql);	}	/**	 * I remove a record from the specified database/table	 *	 * @param [string] $keyvalue the value of the key	 * @return [boolean] the result	 */	public function removeProjects($vo)	{		$keyvalue = $vo[$this->_getKey()];		return $this->conn->execute("DELETE FROM test.projects WHERE ".$this->_getKey()." = '$keyvalue'");	}	/**	 * I get the primary key for table.	 *	 * @return [string] the name of the primary key	 */	private function _getKey()	{		$keys = $this->conn->executeAndReturn("SHOW INDEX FROM test.projects");		$primaryKey = '';		foreach ($keys as $key)		{			if ($key['Key_name'] == 'PRIMARY')			{				$primaryKey = $key['Column_name'];			}		}		return $primaryKey;	}	/**	 * I map the resulting recordset to a projects object.	 *	 * @param [result] a result from a database query	 * @return [array] an array of Projects objects	 */	private function _mapObjectToProjects($obj)	{		$array = array ();		while ($row = mysqli_fetch_assoc($obj))		{			$vo = new ProjectsVO();			foreach ($row as $key=>$value)			{				$vo->__set($key, $value);			}			$array[] = $vo;		}		return $array;	}	/**	 * I execute a statment on the database, and return a array of	 * projects objects.	 *	 * @param [string] the query string to execute	 * @return [array] array of Projects objects	 */	private function _executeReturn($sql)	{		$query = $this->conn->execute($sql);		if ($query)		{			return $this->_mapObjectToProjects($query);		}		else		{			return false;		}	}	/**	 * I execute a raw query and return the result.	 * @param [string] $sql the query	 */	private function _execute($sql)	{		$query = $this->conn->execute($sql);		if ($query)		{			return $this->_mapObject($query);		}		else		{			return false;		}	}	private function _returnSQL($sql)	{		return $sql;	}}/** ============================================================================================== * REST SERVICE FOR CLASS * ============================================================================================== *///Set up the variables for the calls$mode = '';$query = '';/* ******************************************** * Switch based on the mode * ********************************************/$service = new ProjectsService();switch($_SERVER['REQUEST_METHOD']){	case 'GET':		$query = $_GET;		if ( isset ($_GET['m']))		{			$mode = $_GET['m']; //Mode			unset ($query['m']);		}		switch($mode)		{			case 'get':				$result = $service->getAllProjects();				echo json_encode($result);				break;			case 'getOne':				$result = $service->getOne($query);				echo json_encode($result);				break;		}	break;	case 'POST':		$query = $_POST;		if ( isset ($_POST['m']))		{			$mode = $_POST['m']; //Mode			unset ($query['m']);		}		switch($mode)		{			case 'save':				$result = $service->saveProjects($query);				echo json_encode($result);				break;			case 'remove':				$result = $service->removeProjects($query);				echo json_encode($result);				break;		}	break;}?>